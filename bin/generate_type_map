#!/usr/bin/env ruby

require 'slop'
require 'json'

INSTANCE_TYPES = {
  'ap-northeast-2' => 'c4.large',
  'default' => 'm3.medium'
}

def read_json_file(filename)
  doc = File.read(filename)
  JSON.parse(doc)
end

def write_output(data, filename)
  file = File.new(filename, File::CREAT|File::TRUNC|File::RDWR)
  file.write(JSON.pretty_generate(data))
  file.close
end

begin
  opts = Slop.parse do |o|
    o.string '-i', '--in', 'input region map'
    o.string '-o', '--out', 'output file', default: '/dev/stdout'
    o.on '-h', '--help' do
      puts o
      exit
    end
  end

  unless(opts[:in])
    puts opts
    exit
  end

  region_map = read_json_file(opts[:in])

  region_map.each do |region, vars|
    vars['InstanceType'] = INSTANCE_TYPES[region] || INSTANCE_TYPES['default']
  end

  write_output(region_map, opts[:out]);

end
