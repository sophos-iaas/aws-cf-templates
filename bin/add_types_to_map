#!/usr/bin/env ruby

require 'slop'
require 'json'


HA_TYPES = {
  'ap-northeast-2' => 'c4.large',
  'ap-south-1' => 'c4.large',
  'default' => 'm3.medium'
}.freeze

EGW_TYPES = {
  'ap-northeast-2' => 'c4.large',
  'ap-south-1' => 'c4.large',
  'default' => 'm3.medium'
}.freeze

SWARM_TYPES = {
  'ap-northeast-2' => 'c4.large',
  'ap-south-1' => 'c4.large',
  'default' => 'm3.medium'
}.freeze

QUEEN_TYPES = {
  'sa-east-1' => 'm3.large',
  'default' => 'm4.large'
}.freeze

def read_json_file(filename)
  doc = File.read(filename)
  JSON.parse(doc)
end

def write_output(data, filename)
  file = File.new(filename, File::CREAT|File::TRUNC|File::RDWR)
  file.write(JSON.pretty_generate(data))
  file.close
end

begin
  opts = Slop.parse do |o|
    o.string '-i', '--in', 'input region map'
    o.string '-o', '--out', 'output file', default: '/dev/stdout'
    o.on '-h', '--help' do
      puts o
      exit
    end
  end

  unless(opts[:in])
    puts opts
    exit
  end

  region_map = read_json_file(opts[:in])

  region_map.each do |region, vars|
    vars['HAInstanceType'] = HA_TYPES[region] || HA_TYPES['default']
    vars['EGWInstanceType'] = EGW_TYPES[region] || EGW_TYPES['default']
    vars['SwarmInstanceType'] = SWARM_TYPES[region] || SWARM_TYPES['default']
    vars['QueenInstanceType'] = QUEEN_TYPES[region] || QUEEN_TYPES['default']
  end

  write_output(region_map, opts[:out]);

end
