#!/usr/bin/env ruby
$LOAD_PATH.unshift(File.join(File.dirname(__FILE__), '..', 'lib'))

require 'slop'
require 'json'
require 'template_helper/region_map'
require 'pp'

def read_map_file(filename)
  return {} if( filename == '/dev/stdout')
  doc = File.read(filename)
  JSON.parse(doc)
rescue
    return {}
end

def dump_map_file(data, filename)
  file = File.new(filename, File::CREAT|File::TRUNC|File::RDWR)
  file.write(JSON.pretty_generate(data))
  file.close
end

begin
  opts = Slop.parse do |o|
    o.string '--BYOL', 'product-code'
    o.string '--Hourly', 'product-code'
    o.string '--EGW'
    o.string '-o', '--out', 'output file', default: '/dev/stdout'
    o.on '-h', '--help' do
      puts o
      exit
    end
  end
  if !((opts[:BYOL] && opts[:Hourly]) || opts[:EGW])
    puts opts
    exit
  end

  region_map = {}
  if (opts[:BYOL] && opts[:Hourly])
    region_map = TemplateHelper::RegionMap.new('BYOL' => opts[:BYOL], 'Hourly' => opts[:Hourly])
    old_map = read_map_file(opts[:out])
    if (region_map.to_hash == old_map)
      puts "#{opts[:out]} has not changed. Not touching."
    else
      dump_map_file(region_map,opts[:out])
    end
  elsif (opts[:EGW])
    if !ENV.has_key?("AMI_OWNER")
      puts "AMI_OWNER environment variable not set!"
      exit
    end
    region_map = TemplateHelper::RegionMap.new("XXX", "EGW")
    old_map = read_map_file(opts[:out])
    if (region_map.to_hash == old_map)
      puts "#{opts[:out]} has not changed. Not touching."
    else
      dump_map_file(region_map,opts[:out])
    end
  else puts "Unknown options passed!!! Please use options --BYOL, --Hourly, --EGW"
  end
end
